<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party - {{ party_id }}</title>
    <link rel="stylesheet" href="{{ url_for('main.static', filename='css/style.css') }}">
    <script src="{{ url_for('main.static', filename='js/theme.js') }}"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="party-page">
    <div class="party-container">
        <!-- Header -->
        <header class="party-header" id="partyHeader">
            <div>
                <h1>Watch Party</h1>
                <div class="party-code">
                    Party Code: <strong id="partyCode">{{ party_id }}</strong>
                    <button id="copyCodeBtn" class="btn-small">Copy</button>
                    <button id="showLibraryBtn" class="btn-small" style="display: none;">Show Library</button>
                </div>
            </div>
            <div class="user-info">
                <span id="userCount">0 users</span>
                <select id="themeSelector" class="btn-small theme-selector">
                    <option value="cyberpunk">üé≠ Cyberpunk Theater</option>
                    <option value="material">üé® Material Random</option>
                    <option value="emby">üü¢ Emby Green</option>
                    <option value="classic">üåô Classic Dark</option>
                    <option value="minimal">‚òÄÔ∏è Minimal Light</option>
                    <option value="netflix">üé¨ Netflix Red</option>
                </select>
                <button id="leavePartyBtn" class="btn-small btn-danger">Leave</button>
                <button id="collapseHeaderBtn" class="btn-small" title="Collapse header">‚ñ≤</button>
            </div>
        </header>
        <button id="expandHeaderBtn" class="expand-header-btn" title="Expand header" style="display: none;">‚ñº Show Header</button>

        <!-- Main content -->
        <div class="party-content">
            <!-- Left sidebar - Library browser -->
            <aside class="library-sidebar" id="librarySidebar">
                <div class="sidebar-header">
                    <h2>Browse Library</h2>
                    <button id="hideLibraryBtn" class="btn-small btn-danger" title="Hide library for all users">Hide</button>
                </div>

                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search for movies or shows...">
                    <button id="clearSearchBtn" class="clear-search-btn" style="display: none;">√ó</button>
                </div>

                <div class="library-nav">
                    <button class="nav-btn active" data-type="libraries">Libraries</button>
                    <button class="nav-btn" data-type="movies">Movies</button>
                    <button class="nav-btn" data-type="shows">TV Shows</button>
                </div>

                <div id="libraryContent" class="library-content">
                    <p>Loading...</p>
                </div>
            </aside>

            <!-- Main video area -->
            <main class="video-area">
                <div id="noVideoState" class="no-video-state">
                    <div class="placeholder">
                        <h2>No video selected</h2>
                        <p>Browse the library and select a video to start watching together</p>
                    </div>
                </div>

                <div id="videoPlayer" class="video-player" style="display: none;">
                    <video id="videoElement" controls width="100%" preload="auto" crossorigin="anonymous">
                        Your browser does not support the video tag.
                    </video>

                    <!-- Skip Intro Button -->
                    <button id="skipIntroBtn" class="skip-intro-button" onclick="skipIntro()" style="display: none;">
                        Skip Intro ‚è≠Ô∏è
                    </button>

                    <!-- Autoplay Countdown Overlay -->
                    <div id="autoplayCountdown" class="autoplay-countdown" style="display: none;">
                        <div class="countdown-content">
                            <h3 id="nextEpisodeTitle">Next Episode</h3>
                            <p id="nextEpisodeInfo">Loading...</p>
                            <div class="countdown-timer">
                                <span id="countdownNumber">4</span>
                            </div>
                            <button id="cancelAutoplayBtn" class="btn-small btn-danger">Cancel</button>
                        </div>
                    </div>

                    <button id="collapseFooterBtn" class="collapse-footer-btn" title="Collapse footer">‚ñº</button>
                    <div class="video-meta" id="videoMeta">
                        <div class="video-meta-row">
                            <div class="video-info">
                                <h2 id="videoTitle">Video Title</h2>
                                <p id="videoDescription"></p>
                            </div>

                            <div class="video-controls">
                                <div class="stream-controls">
                                    <div class="stream-control-group">
                                        <label for="audioSelect">Audio:</label>
                                        <select id="audioSelect" class="stream-select">
                                            <option value="">Loading...</option>
                                        </select>
                                    </div>
                                    <div id="subtitleControlContainer" class="stream-control-group">
                                        <label for="subtitleSelect">Subtitles:</label>
                                        <select id="subtitleSelect" class="stream-select">
                                            <option value="">Loading...</option>
                                        </select>
                                    </div>
                                    <div class="stream-control-group autoplay-toggle-group">
                                        <label for="autoplayToggle">Play next Episode:</label>
                                        <button id="autoplayToggle" class="btn-small autoplay-toggle" data-enabled="true" title="Automatically play next episode when current one ends">
                                            <span class="toggle-text">ON</span>
                                        </button>
                                    </div>
                                    <div class="stream-control-group stop-button-group">
                                        <label>&nbsp;</label>
                                        <button id="stopVideoBtn" class="btn-small btn-danger" style="display: none;">Stop Video</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat -->
                <button id="expandChatBtn" class="expand-chat-btn" title="Expand chat" style="display: none;">‚óÄ Chat</button>
                <div class="chat-container" id="chatContainer">
                    <div class="chat-resize-handle" id="chatResizeHandle"></div>
                    <div class="chat-header">
                        <h3>Chat</h3>
                        <button id="collapseChatBtn" class="btn-small" title="Collapse chat">‚ñ∂</button>
                    </div>
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message..." />
                        <button id="sendChatBtn" class="btn-small">Send</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Username modal -->
    <div id="usernameModal" class="modal">
        <div class="modal-content">
            <h2>Join Watch Party</h2>
            <p>Enter your name (or leave blank for random name):</p>
            <input type="text" id="usernameInput" placeholder="Your name (optional)" />
            <button id="joinBtn" class="btn btn-primary">Join</button>
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.85rem; opacity: 0.7; text-align: center;">
                Special thanks to <a href="https://emby.media/community/index.php?/profile/1658172-quackmasterdan/" target="_blank" rel="noopener noreferrer" style="color: var(--cyber-primary); text-decoration: none; font-weight: bold;">QuackMasterDan</a> for dedication in testing! üéâ
            </div>
        </div>
    </div>

    <script>
        // Configuration passed from server
        const APP_PREFIX = '{{ app_prefix }}';
        const SOCKETIO_PATH = '{{ socketio_path }}';
    </script>
    <script src="{{ url_for('main.static', filename='js/party.js') }}"></script>
</body>
</html>
